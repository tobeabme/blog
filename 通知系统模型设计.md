几乎每个站点都有消息通知系统，可见通知系统的重要性不言而喻。通知系统看似简单，实际上比较复杂。那么本篇主要讲解常见的消息通知系统的设计和具体实现，包括数据库设计、逻辑关系分析等。


** 我们常见的站内通知有以下几种类别：**
* 公告 Announcement
* 提醒 Remind
    * 资源订阅提醒「我关注的资源有更新、评论等事件时通知我」
    * 资源发布提醒「我发布的资源有评论、收藏等事件时通知我」
    * 系统提醒「平台会根据一些算法、规则等可能会对你的资源做一些事情，这时你会收到系统通知」
* 私信 Mailbox

以上三种消息有各自特点，实现也各不相同，其中「提醒」类通知是最复杂的，下面会详细讲。

## 通知系统设计与实现

为了能够更加通俗易懂一点，接下来我会按照通知事件发送的时间顺序开始讲解。

### 通知系统概要

* 通知事件
* 通知设置
* 通知提醒
* 消息推送.方式
    * 一对一推送
    * 一对多推送

* 通知推送.渠道
    * 站内
    * 站外
        * 安卓系统应用
        * IOS系统应用
        * 邮箱
        * 短信
        * WhatsAPP
        * 其它

* 通知推送技术
    * websocket
    * 第三方SDK开发或接入    

* 通知接收.渠道
    * 站内
    * 站外
        * 安卓系统应用
        * IOS系统应用
        * 邮箱
        * 短信
        * WhatsAPP
        * 其它

* 消息聚合

### 通知事件

#### 什么是通知事件？ 

通知事件就是当用户在网站或应用上产生了支付行为之后，如果你想给用户一个通知，告诉她系统已收到她的付款，那么你就要把这个「支付行为」定义为一个通知事件，并且保存这个通知事件到「通知事件表」里，以便通知系统作异步处理。通知系统会不断的处理「通知事件表」里的数据，分析每一个事件应该通知和不通知哪些人。

**通知事件表「notify_event」**  

记录每一个用户行为产生的通知事件信息

表结构如下：
```
id: {type: 'integer', primaryKey: true, autoIncrement:true} 
userID: {type: 'string', required: true} //用户ID
action: {type: 'string', required: true} //动作，如：捐款/更新/评论/收藏
objectID: {type: 'string', required: true}, //对象ID，如：文章ID；
objectType: {type: 'string', required: true} //对象所属类型，如：人、文章、活动、视频等；
createdAt：{type: 'timestamp', required: true} //创建时间；
```

#### 用户行为定义 

「action」即用户行为，如：赞了、评论了、喜欢了、捐款了、收藏了；一般来讲，我们把一个用户行为定义为一个通知类型，那么用户行为必须是需要提前定义好的。

由消息系统内部定义，为后台提供接口，用于通知设置。如下：

```
notify_action_type := ["donated","conllected","commented","updated"]
```

#### 对象类型定义 

「objectType」即用户行为作用的对象的所属类型，简单的说就是资源类型，如：项目、文章、评论、商品、视频、图片、用户。

由消息系统内部定义，为后台提供接口，用于通知设置。如下：

```
notify_object_type := ["project","comment"]
```


### 通知设置
=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=

结构体

type NotifySetting struct {
    NotifyActionType []string
    NotifyObjectType []string
    NotifyTemplates []string
    NotifyChannel []string
}





通知模版「notify_templates」
XXX 喜欢了你的文章 《消息通知系统模型设计》
你喜欢的文章《消息通知系统模型设计》有新的评论

```
notify_templates := ["donated","conllected","updated"]

message.SetString(language.AmericanEnglish, "donated", "XXXXXXXXXXXXXXXXXXXXXXXXXXXXX.")
message.SetString(language.AmericanEnglish, "conllected", "XXXXXXXXXXXXXXXXXXXXXXXXXXXXX.")
message.SetString(language.AmericanEnglish, "updated", "XXXXXXXXXXXXXXXXXXXXXXXXXXXXX.")
```

通知渠道表「notify_channel」
站内，短信，邮件，设备，WhatsAPP

```
notify_channel := ["inside","device","sms","email","whatsapp"]
```

=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=

通知设置表「notify_setting」
为用户在通知设置页面提供屏蔽通知的设置选项，如：
通知提醒
    {我关注的}{项目}有动态{更新}时通知我
    有人{收藏}{我发布的}{项目}时通知我

表结构如下：
```
id: {type: 'integer', primaryKey: true, autoIncrement:true} //通知设置编号；
objectType: {type: 'string', required: true} //资源对象类型，如：项目、文章、评论、商品、视频、图片、用户；
action: {type: 'string', required: true} //动作，也即通知类型，如：捐款、更新、评论、收藏
objectRelationship: {type: 'string', required: true} //用户与资源的关系，如：用户发布的published，用户关注的followed；
notifyTemplate: {type: 'string', required: true} //为某个通知类型设置对应的通知模版
notify_channel: {type: 'string', required: true} //为某个通知类型设置一个或多个推送渠道
description: {type: 'string', required: true}  //设置选项的内容描述
settingType: {type: 'string', required: true} //remind、privateLetters
```

=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=

通知用户提醒设置表「notify_setting_user」
当无用户的任何记录时，即用户没有设置时，默认代表用户是开启了接收此类通知的；否则如果有用户的设置记录，则代表用户关闭了此类通知的接收；

表结构如下：
```
id: {type: 'integer', primaryKey: true, autoIncrement:true} //用户通知设置ID；
userId: {type: 'string', required: true}，//用户ID，对应 notify_remind 中的 recipientId；
settingId: {type: 'string', required: true}，//通知设置表ID
createdAt：{type: 'timestamp', required: true} //创建时间；
```

=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-==-=-=-=-=-=-=-=


提醒表「notify_remind」
所有用户的通知消息记录将存放在这里

表结构如下：
```
id: {type: 'integer', primaryKey: true, autoIncrement:true} //主键；
remindID: {type: 'string', required: true} //通知提醒编号；
senderID: {type: 'string', required: true} //操作者的ID，三个0代表是系统发送的；
senderName: {type: 'string’, required: true} //操作者用户名；
senderAction: {type: 'string', required: true} //操作者的动作，如：捐款、更新、评论、收藏；
objectID: {type: 'string', required: true}, //目标对象ID；
object: {type: 'string', required: false}, //目标对象内容或简介，比如：文章标题；
objectType: {type: 'string', required: true} //被操作对象类型，如：人、文章、活动、视频等；
recipientID: {type: 'string’} //消息接收者；可能是对象的所有者或订阅者；
message: {type: 'text', required: true} //消息内容，由提醒模版生成，需要提前定义；
createdAt：{type: 'timestamp', required: true} //创建时间；
status：{type: 'integer', required: false} //是否阅读，默认未读；
readAt:{type: 'timestamp', required: false} //阅读时间；
```
